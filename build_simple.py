# -*- coding: utf-8 -*-
"""
å•æ–‡ä»¶æ‰“åŒ…è„šæœ¬ - è§£å†³NumPyå…¼å®¹æ€§é—®é¢˜
"""
import subprocess
import sys
import shutil
from pathlib import Path
import datetime

def create_usage_instructions():
    """åˆ›å»ºè¯¦ç»†çš„ä½¿ç”¨è¯´æ˜æ–‡ä»¶"""
    current_time = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    usage_content = f"""
# Excelæ•°æ®å¤„ç†å·¥å…· - ä½¿ç”¨è¯´æ˜

## æ‰“åŒ…ä¿¡æ¯
- æ‰“åŒ…æ—¶é—´: {current_time}
- æ–‡ä»¶ä½ç½®: Excelæ•°æ®å¤„ç†å·¥å…·.exe

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¦–æ¬¡ä½¿ç”¨ - è®¾ç½®æ¨¡æ¿
åœ¨ä½¿ç”¨æœ¬å·¥å…·ä¹‹å‰ï¼Œæ‚¨éœ€è¦å…ˆè®¾ç½®Excelæ¨¡æ¿æ–‡ä»¶ï¼š

#### æ­¥éª¤1ï¼šå¯åŠ¨ç¨‹åº
åŒå‡»"Excelæ•°æ®å¤„ç†å·¥å…·.exe"å¯åŠ¨ç¨‹åº

#### æ­¥éª¤2ï¼šæ‰“å¼€è®¾ç½®
- ç‚¹å‡»èœå•æ çš„"è®¾ç½®"
- é€‰æ‹©"æ¨¡æ¿è®¾ç½®"

#### æ­¥éª¤3ï¼šé…ç½®æ¨¡æ¿
**UPSæ€»ç»“å•æ¨¡æ¿è®¾ç½®:**
- ç‚¹å‡»"é€‰æ‹©UPSæ€»ç»“å•æ¨¡æ¿"æŒ‰é’®
- é€‰æ‹©æ‚¨çš„UPS Excelæ¨¡æ¿æ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰
- ç¡®ä¿æ¨¡æ¿åŒ…å«å¿…è¦çš„åˆ—æ ‡é¢˜å’Œæ ¼å¼

**DPDæ•°æ®é¢„æŠ¥æ¨¡æ¿è®¾ç½®:**
- ç‚¹å‡»"é€‰æ‹©DPDæ•°æ®é¢„æŠ¥æ¨¡æ¿"æŒ‰é’®  
- é€‰æ‹©æ‚¨çš„DPD Excelæ¨¡æ¿æ–‡ä»¶ï¼ˆ.xlsxæ ¼å¼ï¼‰
- ç¡®ä¿æ¨¡æ¿åŒ…å«å¿…è¦çš„åˆ—æ ‡é¢˜å’Œæ ¼å¼

#### æ­¥éª¤4ï¼šä¿å­˜è®¾ç½®
- ç‚¹å‡»"ä¿å­˜è®¾ç½®"æŒ‰é’®
- ç³»ç»Ÿä¼šæç¤ºè®¾ç½®ä¿å­˜æˆåŠŸ

### 2. æ—¥å¸¸ä½¿ç”¨è¯´æ˜

#### å¤„ç†Excelæ–‡ä»¶çš„æ­¥éª¤ï¼š

**ç¬¬1æ­¥ï¼šä¸Šä¼ æ–‡ä»¶**
- ç‚¹å‡»ä¸»ç•Œé¢çš„"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®
- é€‰æ‹©éœ€è¦å¤„ç†çš„Excelæ–‡ä»¶ï¼ˆæ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼‰
- æ–‡ä»¶è·¯å¾„ä¼šæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š

**ç¬¬2æ­¥ï¼šé€‰æ‹©å¤„ç†ç±»å‹**
- åœ¨ç•Œé¢ä¸Šé€‰æ‹©å¤„ç†ç±»å‹ï¼š
  - ğŸšš UPSå¤„ç†ï¼šä½¿ç”¨UPSæ€»ç»“å•æ¨¡æ¿
  - ğŸ“¦ DPDå¤„ç†ï¼šä½¿ç”¨DPDæ•°æ®é¢„æŠ¥æ¨¡æ¿

**ç¬¬3æ­¥ï¼šå¼€å§‹å¤„ç†**
- ç‚¹å‡»"å¼€å§‹å¤„ç†"æŒ‰é’®
- ç¨‹åºä¼šè‡ªåŠ¨å¤„ç†æ•°æ®å¹¶å¡«å……åˆ°å¯¹åº”æ¨¡æ¿
- å¤„ç†è¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºè¿›åº¦ä¿¡æ¯

**ç¬¬4æ­¥ï¼šæŸ¥çœ‹ç»“æœ**
- å¤„ç†å®Œæˆåï¼Œæ–‡ä»¶ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ¡Œé¢
- æ–‡ä»¶åæ ¼å¼ï¼šå¤„ç†ç±»å‹_æ—¶é—´æˆ³.xlsx
- ç³»ç»Ÿä¼šæ˜¾ç¤ºä¿å­˜ä½ç½®

## ğŸ“‹ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼

### è¾“å…¥æ–‡ä»¶
- Excelæ–‡ä»¶ï¼š.xlsx, .xls
- å»ºè®®ä½¿ç”¨.xlsxæ ¼å¼ä»¥è·å¾—æœ€ä½³å…¼å®¹æ€§

### è¾“å‡ºæ–‡ä»¶
- ç»Ÿä¸€è¾“å‡ºä¸º.xlsxæ ¼å¼
- è‡ªåŠ¨ä¿å­˜åˆ°Windowsæ¡Œé¢
- æ–‡ä»¶ååŒ…å«æ—¶é—´æˆ³ï¼Œé¿å…è¦†ç›–

## âš™ï¸ ç³»ç»Ÿè¦æ±‚

### æœ€ä½è¦æ±‚
- Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
- 500MB å¯ç”¨ç£ç›˜ç©ºé—´
- 4GB å†…å­˜ï¼ˆæ¨è8GBï¼‰

### æƒé™è¦æ±‚
- æ¡Œé¢å†™å…¥æƒé™ï¼ˆä¿å­˜è¾“å‡ºæ–‡ä»¶ï¼‰
- æ–‡ä»¶è¯»å–æƒé™ï¼ˆè¯»å–Excelæ–‡ä»¶å’Œæ¨¡æ¿ï¼‰

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

**é—®é¢˜1ï¼šç¨‹åºæ— æ³•å¯åŠ¨**
- è§£å†³æ–¹æ¡ˆï¼šä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œç¨‹åº
- æ£€æŸ¥æ˜¯å¦è¢«æ€æ¯’è½¯ä»¶æ‹¦æˆªï¼Œæ·»åŠ ä¿¡ä»»

**é—®é¢˜2ï¼šæ‰¾ä¸åˆ°æ¨¡æ¿æ–‡ä»¶**
- è§£å†³æ–¹æ¡ˆï¼šé‡æ–°è®¾ç½®æ¨¡æ¿è·¯å¾„
- ç¡®ä¿æ¨¡æ¿æ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»
- æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ ¼å¼æ˜¯å¦ä¸º.xlsx

**é—®é¢˜3ï¼šæ— æ³•ä¿å­˜è¾“å‡ºæ–‡ä»¶**
- è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ¡Œé¢å†™å…¥æƒé™
- ç¡®ä¿ç£ç›˜ç©ºé—´å……è¶³
- å…³é—­å¯èƒ½å ç”¨æ–‡ä»¶çš„å…¶ä»–ç¨‹åº

**é—®é¢˜4ï¼šå¤„ç†å¤±è´¥æˆ–æ•°æ®é”™è¯¯**
- è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥è¾“å…¥Excelæ–‡ä»¶æ ¼å¼
- ç¡®è®¤æ•°æ®åˆ—æ ‡é¢˜ä¸æ¨¡æ¿åŒ¹é…
- æ£€æŸ¥æ˜¯å¦æœ‰ç©ºè¡Œæˆ–æ ¼å¼å¼‚å¸¸

**é—®é¢˜5ï¼šç¨‹åºè¿è¡Œç¼“æ…¢**
- è§£å†³æ–¹æ¡ˆï¼šå¤„ç†å¤§æ–‡ä»¶æ—¶è¯·è€å¿ƒç­‰å¾…
- å…³é—­å…¶ä»–å ç”¨å†…å­˜çš„ç¨‹åº
- è€ƒè™‘åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è·å–å¸®åŠ©
å¦‚éœ€æŠ€æœ¯æ”¯æŒï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. é”™è¯¯æˆªå›¾æˆ–é”™è¯¯ä¿¡æ¯
2. è¯¦ç»†çš„æ“ä½œæ­¥éª¤
3. ä½¿ç”¨çš„Excelæ–‡ä»¶ç¤ºä¾‹ï¼ˆå¦‚å¯åˆ†äº«ï¼‰
4. ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯

### æ³¨æ„äº‹é¡¹
- è¯·å®šæœŸå¤‡ä»½é‡è¦çš„Excelæ–‡ä»¶
- å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆéªŒè¯æ¨¡æ¿é…ç½®
- å¤„ç†å¤§æ–‡ä»¶æ—¶è¯·ç¡®ä¿ç³»ç»Ÿç¨³å®š
- é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦è¾ƒé•¿å¯åŠ¨æ—¶é—´

### ç‰ˆæœ¬ä¿¡æ¯
- å·¥å…·ç‰ˆæœ¬ï¼š1.0
- æ‰“åŒ…æ—¶é—´ï¼š{current_time}
- æ”¯æŒæ ¼å¼ï¼šExcel .xlsx/.xls

---
Â© Excelæ•°æ®å¤„ç†å·¥å…· - ä¸“ä¸šçš„Excelæ•°æ®å¤„ç†è§£å†³æ–¹æ¡ˆ
"""

    # ä¿å­˜è¯´æ˜æ–‡ä»¶åˆ°distç›®å½•
    dist_dir = Path('dist')
    if dist_dir.exists():
        usage_file = dist_dir / 'ä½¿ç”¨è¯´æ˜.txt'
        try:
            with open(usage_file, 'w', encoding='utf-8') as f:
                f.write(usage_content)
            print(f"[OK] å·²ç”Ÿæˆä½¿ç”¨è¯´æ˜: {usage_file}")
        except Exception as e:
            print(f"[WARNING] ç”Ÿæˆä½¿ç”¨è¯´æ˜å¤±è´¥: {e}")
    
    # åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
    print("\n" + "="*60)
    print("ğŸ“– ä½¿ç”¨è¯´æ˜è¦ç‚¹ï¼š")
    print("="*60)
    print("1. é¦–æ¬¡ä½¿ç”¨éœ€è¦è®¾ç½®æ¨¡æ¿ï¼š")
    print("   - å¯åŠ¨ç¨‹åº â†’ è®¾ç½® â†’ æ¨¡æ¿è®¾ç½®")
    print("   - åˆ†åˆ«é€‰æ‹©UPSå’ŒDPDæ¨¡æ¿æ–‡ä»¶")
    print("   - ç‚¹å‡»ä¿å­˜è®¾ç½®")
    print()
    print("2. æ—¥å¸¸ä½¿ç”¨æµç¨‹ï¼š")
    print("   - é€‰æ‹©Excelæ–‡ä»¶ â†’ é€‰æ‹©å¤„ç†ç±»å‹ â†’ å¼€å§‹å¤„ç†")
    print("   - ç»“æœè‡ªåŠ¨ä¿å­˜åˆ°æ¡Œé¢")
    print() 
    print("3. æ³¨æ„äº‹é¡¹ï¼š")
    print("   - æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼")
    print("   - è¾“å‡ºæ–‡ä»¶ä¿å­˜åˆ°æ¡Œé¢")
    print("   - é¦–æ¬¡å¯åŠ¨å¯èƒ½è¾ƒæ…¢")
    print("="*60)

def onefile_build():
    """ä½¿ç”¨å•æ–‡ä»¶æ¨¡å¼æ‰“åŒ…"""
    try:
        print("Starting single file packaging...")
    except UnicodeEncodeError:
        print("Starting single file packaging...")

    # åˆ é™¤distç›®å½•
    if Path('dist').exists():
        shutil.rmtree('dist')
    # åˆ é™¤buildç›®å½•  
    if Path('build').exists():
        shutil.rmtree('build')

    cmd = [
        sys.executable, '-m', 'PyInstaller',
        '--onefile',  # å•æ–‡ä»¶æ¨¡å¼
        '--windowed',  # æ— æ§åˆ¶å°
        '--name=Excelæ•°æ®å¤„ç†å·¥å…·',
        '--add-data=templates;templates',
        '--add-data=assets;assets',

        # å…³é”®çš„éšè—å¯¼å…¥ï¼Œè§£å†³NumPyé—®é¢˜
        '--hidden-import=pandas',
        '--hidden-import=pandas._libs.tslibs.timedeltas',
        '--hidden-import=pandas._libs.tslibs.np_datetime',
        '--hidden-import=pandas._libs.tslibs.nattype',
        '--hidden-import=pandas._libs.skiplist',
        '--hidden-import=openpyxl',
        '--hidden-import=openpyxl.workbook',
        '--hidden-import=openpyxl.worksheet.worksheet',
        '--hidden-import=ttkbootstrap',
        '--hidden-import=PIL',
        '--hidden-import=tkinter',
        '--hidden-import=numpy',
        '--hidden-import=numpy.core._methods',
        '--hidden-import=numpy.lib.format',
        '--hidden-import=numpy.core._dtype_ctypes',

        # æ’é™¤ä¸éœ€è¦çš„åŒ…
        '--exclude-module=PyQt5',
        '--exclude-module=PyQt6',
        '--exclude-module=matplotlib',
        '--exclude-module=scipy',
        '--exclude-module=streamlit',

        # å…¶ä»–é€‰é¡¹
        '--clean',
        '--noconfirm',

        'main.py'
    ]

    print(f"æ‰§è¡Œå‘½ä»¤: {' '.join(cmd)}")

    try:
        result = subprocess.run(cmd, check=True, capture_output=True, text=True)
        print("[OK] å•æ–‡ä»¶æ‰“åŒ…æˆåŠŸï¼")
        print("exeæ–‡ä»¶ä½ç½®: dist/Excelæ•°æ®å¤„ç†å·¥å…·.exe")

        # æ£€æŸ¥æ–‡ä»¶å¤§å°
        exe_file = Path('dist/Excelæ•°æ®å¤„ç†å·¥å…·.exe')
        if exe_file.exists():
            size_mb = exe_file.stat().st_size / (1024 * 1024)
            print(f"æ–‡ä»¶å¤§å°: {size_mb:.1f} MB")
            
            # ç”Ÿæˆä½¿ç”¨è¯´æ˜æ–‡ä»¶
            create_usage_instructions()

        return True
    except subprocess.CalledProcessError as e:
        print(f"[ERROR] æ‰“åŒ…å¤±è´¥: {e}")
        print("STDOUT:", e.stdout)
        print("STDERR:", e.stderr)
        return False

if __name__ == "__main__":
    onefile_build()