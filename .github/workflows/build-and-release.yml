name: Build and Release Excel Tool

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®å¿…è¦çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»ºReleaseå’Œä¸Šä¼ èµ„äº§
  packages: write  # å…è®¸ä¸Šä¼ åŒ…

jobs:
  build-windows:
    runs-on: windows-latest

    env:
      PYTHONIOENCODING: utf-8
      # è®¾ç½®PowerShellçš„é»˜è®¤ç¼–ç è¡Œä¸º
      PSDefaultParameterValues: "*:Encoding=utf8"

    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å‡çº§pip
      run: python -m pip install --upgrade pip
      
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: éªŒè¯ç¯å¢ƒ
      run: |
        python --version
        pip list
        
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        if (!(Test-Path "templates")) { New-Item -ItemType Directory -Path "templates" }
        if (!(Test-Path "assets")) { New-Item -ItemType Directory -Path "assets" }
        
    - name: è®¾ç½®æ§åˆ¶å°ç¼–ç 
      run: |
        # è®¾ç½®PowerShellå’Œæ§åˆ¶å°ç¼–ç ä¸ºUTF-8 (å…¼å®¹PowerShell 7)
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $PSDefaultParameterValues['*:Encoding'] = 'utf8'
        $env:PYTHONIOENCODING = "utf-8"
        # è®¾ç½®å½“å‰ä¼šè¯çš„æ–‡ä»¶ç¼–ç 
        $OutputEncoding = [System.Text.Encoding]::UTF8
        # ç¡®ä¿PowerShellæ¨¡å—ä½¿ç”¨UTF-8
        $PSDefaultParameterValues['Out-File:Encoding'] = 'utf8'
        $PSDefaultParameterValues['Set-Content:Encoding'] = 'utf8'
        Write-Host "Console and PowerShell encoding set to UTF-8"
        
    - name: æ‰§è¡Œæ‰“åŒ…
      run: python build_github.py
      
    - name: éªŒè¯æ‰“åŒ…ç»“æœ
      run: |
        # ä½¿ç”¨Get-ChildItemæŸ¥æ‰¾EXEæ–‡ä»¶ï¼Œé¿å…ä¸­æ–‡è·¯å¾„ç¼–ç é—®é¢˜
        $exeFiles = Get-ChildItem -Path "dist" -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          $exeFile = $exeFiles[0]
          Write-Host "âœ… EXEæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $($exeFile.Name)"
          $size = $exeFile.Length / 1MB
          Write-Host "æ–‡ä»¶å¤§å°: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ EXEæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          Get-ChildItem -Path "dist" -Force | Format-Table Name, Length -AutoSize
          exit 1
        }
        
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        if (Test-Path "release") { Remove-Item "release" -Recurse -Force }
        New-Item -ItemType Directory -Path "release"

        # æ™ºèƒ½å¤åˆ¶EXEæ–‡ä»¶ï¼ˆä¿æŒåŸå§‹æ–‡ä»¶åï¼‰
        $exeFiles = Get-ChildItem -Path "dist" -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          $exeFile = $exeFiles[0]
          Copy-Item $exeFile.FullName "release/"
          Write-Host "âœ… å¤åˆ¶EXEæ–‡ä»¶: $($exeFile.Name)"
        }

        # æ™ºèƒ½å¤åˆ¶è¯´æ˜æ–‡ä»¶ï¼ˆä¿æŒåŸå§‹æ–‡ä»¶åï¼‰
        $txtFiles = Get-ChildItem -Path "dist" -Filter "*.txt"
        if ($txtFiles.Count -gt 0) {
          foreach ($txtFile in $txtFiles) {
            Copy-Item $txtFile.FullName "release/"
            Write-Host "âœ… å¤åˆ¶è¯´æ˜æ–‡ä»¶: $($txtFile.Name)"
          }
        }
        
        if (Test-Path "templates") {
          Copy-Item "templates" "release/" -Recurse
        }
        if (Test-Path "assets") {
          Copy-Item "assets" "release/" -Recurse
        }
        
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $matches[1] } else { "dev-build" }
        $buildTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        
        $content = "# Excel Data Processor - Version Information`n`n"
        $content += "Version: $version`n"
        $content += "Build Time: $buildTime`n"
        $content += "Build Environment: GitHub Actions`n"
        $content += "Operating System: Windows Latest`n"
        $content += "Python Version: 3.11`n`n"
        $content += "## File Description`n"
        # åŠ¨æ€ç”Ÿæˆæ–‡ä»¶æè¿°
        $exeFiles = Get-ChildItem -Path "release" -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          $content += "- $($exeFiles[0].Name): Main application (Excelæ•°æ®å¤„ç†å·¥å…·)`n"
        }
        $txtFiles = Get-ChildItem -Path "release" -Filter "*.txt" | Where-Object { $_.Name -ne "VersionInfo.txt" }
        if ($txtFiles.Count -gt 0) {
          foreach ($txtFile in $txtFiles) {
            $content += "- $($txtFile.Name): Usage instructions and documentation`n"
          }
        }
        $content += "- templates/: Template files directory (if available)`n"
        $content += "- assets/: Asset files directory (if available)`n`n"
        $content += "## Installation Instructions`n"
        $content += "1. Download and extract the complete package`n"
        if ($exeFiles.Count -gt 0) {
          $content += "2. Double-click '$($exeFiles[0].Name)' to start the application`n"
        } else {
          $content += "2. Double-click the main executable file to start`n"
        }
        $content += "3. First-time use requires template file configuration`n"
        $content += "4. See the included documentation files for detailed instructions`n"
        
        $content | Out-File -FilePath "release/VersionInfo.txt" -Encoding UTF8
        
    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $matches[1] } else { "dev-build" }
        $zipName = "ExcelDataProcessor-$version-Windows.zip"
        Compress-Archive -Path "release/*" -DestinationPath $zipName
        Write-Host "Created ZIP: $zipName"
        
    - name: è·å–ç‰ˆæœ¬æ ‡ç­¾
      id: get_version
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/(.+)') {
          $version = $matches[1]
        } else {
          $version = "dev-build-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        $buildTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "build_time=$buildTime" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
        echo "Build Time: $buildTime"
        
    - name: åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰€æœ‰èµ„äº§
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $buildTime = "${{ steps.get_version.outputs.build_time }}"

        # åˆ›å»ºReleaseè¯´æ˜
        $releaseBody = @"
## ğŸ“¦ Excel Data Processor $version

### âœ¨ Main Features
- ğŸšš UPS Data Processing: Read Excel files and fill data using UPS templates
- ğŸ“¦ DPD Data Processing: Read Excel files and process data using DPD templates
- ğŸ¯ One-click Processing: Select file â†’ Choose type â†’ Auto process â†’ Save to desktop
- âš™ï¸ Template Settings: Support custom UPS and DPD Excel templates

### ğŸš€ Quick Start
1. **Download**: Download the ZIP package or individual files below
2. **Extract**: Extract to any directory (if using ZIP)
3. **Launch**: Double-click the main application file (.exe)
4. **Setup**: First-time use requires template configuration in Settings
5. **Use**: Follow the interface prompts to process Excel files

### ğŸ“‹ System Requirements
- Windows 10 or higher
- 500MB available disk space
- Supported Excel formats: .xlsx, .xls

### ğŸ“– Documentation
Complete user guide included in the package

### ğŸ”§ Technical Information
- Build Time: $buildTime
- Python Version: 3.11
- Packaging Tool: PyInstaller
- Architecture: Windows x64
"@

        # ä½¿ç”¨ghåˆ›å»ºRelease
        gh release create $version --title "Excel Data Processor $version" --notes $releaseBody

        # ä¸Šä¼ ZIPåŒ…
        $zipFile = "ExcelDataProcessor-$version-Windows.zip"
        if (Test-Path $zipFile) {
          gh release upload $version $zipFile --clobber
          Write-Host "âœ… å·²ä¸Šä¼ ZIPåŒ…: $zipFile"
        }

        # ä¸Šä¼ å•ç‹¬çš„EXEæ–‡ä»¶
        $exeFiles = Get-ChildItem -Path "dist" -Filter "*.exe"
        if ($exeFiles.Count -gt 0) {
          foreach ($exeFile in $exeFiles) {
            gh release upload $version $exeFile.FullName --clobber
            Write-Host "âœ… å·²ä¸Šä¼ EXEæ–‡ä»¶: $($exeFile.Name)"
          }
        }

        Write-Host "ğŸ‰ Releaseåˆ›å»ºå®Œæˆ: $version"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        Write-Host "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
        Write-Host "ğŸ“¦ Releaseç‰ˆæœ¬: $version"
        Write-Host "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${{ github.repository }}/releases/tag/$version"