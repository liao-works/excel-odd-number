name: Build and Release Excel Tool

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„tagæ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: å‡çº§pip
      run: python -m pip install --upgrade pip
      
    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r requirements.txt
        
    - name: éªŒè¯ç¯å¢ƒ
      run: |
        python --version
        pip list
        
    - name: åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        if (!(Test-Path "templates")) { New-Item -ItemType Directory -Path "templates" }
        if (!(Test-Path "assets")) { New-Item -ItemType Directory -Path "assets" }
        
    - name: æ‰§è¡Œæ‰“åŒ…
      run: python build_simple.py
      
    - name: éªŒè¯æ‰“åŒ…ç»“æœ
      run: |
        $exePath = "dist/Excelæ•°æ®å¤„ç†å·¥å…·.exe"
        if (Test-Path $exePath) {
          Write-Host "âœ… EXEæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          $size = (Get-Item $exePath).Length / 1MB
          Write-Host "æ–‡ä»¶å¤§å°: $([math]::Round($size, 1)) MB"
        } else {
          Write-Host "âŒ EXEæ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          exit 1
        }
        
    - name: é‡å‘½åæ–‡ä»¶ä¸ºè‹±æ–‡
      run: |
        if (Test-Path "dist/Excelæ•°æ®å¤„ç†å·¥å…·.exe") {
          Rename-Item "dist/Excelæ•°æ®å¤„ç†å·¥å…·.exe" "dist/ExcelDataProcessor.exe"
        }
        if (Test-Path "dist/ä½¿ç”¨è¯´æ˜.txt") {
          Rename-Item "dist/ä½¿ç”¨è¯´æ˜.txt" "dist/UserGuide.txt"
        }
        
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        if (Test-Path "release") { Remove-Item "release" -Recurse -Force }
        New-Item -ItemType Directory -Path "release"
        
        Copy-Item "dist/ExcelDataProcessor.exe" "release/"
        Copy-Item "dist/UserGuide.txt" "release/"
        
        if (Test-Path "templates") {
          Copy-Item "templates" "release/" -Recurse
        }
        if (Test-Path "assets") {
          Copy-Item "assets" "release/" -Recurse
        }
        
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $matches[1] } else { "dev-build" }
        $buildTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        
        $content = "# Excel Data Processor - Version Information`n`n"
        $content += "Version: $version`n"
        $content += "Build Time: $buildTime`n"
        $content += "Build Environment: GitHub Actions`n"
        $content += "Operating System: Windows Latest`n"
        $content += "Python Version: 3.11`n`n"
        $content += "## File Description`n"
        $content += "- ExcelDataProcessor.exe: Main application`n"
        $content += "- UserGuide.txt: Detailed usage instructions`n"
        $content += "- templates/: Template files directory (if available)`n"
        $content += "- assets/: Asset files directory (if available)`n`n"
        $content += "## Installation Instructions`n"
        $content += "1. Download and extract the complete package`n"
        $content += "2. Double-click ExcelDataProcessor.exe to start`n"
        $content += "3. First-time use requires template file configuration`n"
        $content += "4. See UserGuide.txt for detailed instructions`n"
        
        $content | Out-File -FilePath "release/VersionInfo.txt" -Encoding UTF8
        
    - name: åˆ›å»ºå‹ç¼©åŒ…
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/(.+)') { $matches[1] } else { "dev-build" }
        $zipName = "ExcelDataProcessor-$version-Windows.zip"
        Compress-Archive -Path "release/*" -DestinationPath $zipName
        Write-Host "Created ZIP: $zipName"
        
    - name: è·å–ç‰ˆæœ¬æ ‡ç­¾
      id: get_version
      run: |
        if ($env:GITHUB_REF -match 'refs/tags/(.+)') {
          $version = $matches[1]
        } else {
          $version = "dev-build-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        $buildTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "build_time=$buildTime" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
        echo "Build Time: $buildTime"
        
    - name: åˆ›å»ºRelease
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: Excel Data Processor ${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ“¦ Excel Data Processor ${{ steps.get_version.outputs.version }}
          
          ### âœ¨ Main Features
          - ğŸšš UPS Data Processing: Read Excel files and fill data using UPS templates
          - ğŸ“¦ DPD Data Processing: Read Excel files and process data using DPD templates
          - ğŸ¯ One-click Processing: Select file â†’ Choose type â†’ Auto process â†’ Save to desktop
          - âš™ï¸ Template Settings: Support custom UPS and DPD Excel templates
          
          ### ğŸš€ Quick Start
          1. **Download**: Download `ExcelDataProcessor-${{ steps.get_version.outputs.version }}-Windows.zip`
          2. **Extract**: Extract to any directory
          3. **Launch**: Double-click `ExcelDataProcessor.exe`
          4. **Setup**: First-time use requires template configuration in Settings
          5. **Use**: Follow the interface prompts to process Excel files
          
          ### ğŸ“‹ System Requirements
          - Windows 10 or higher
          - 500MB available disk space
          - Supported Excel formats: .xlsx, .xls
          
          ### ğŸ“– Documentation
          Complete user guide included in the package: `UserGuide.txt`
          
          ### ğŸ”§ Technical Information
          - Build Time: ${{ steps.get_version.outputs.build_time }}
          - Python Version: 3.11
          - Packaging Tool: PyInstaller
          - Architecture: Windows x64
        draft: false
        prerelease: false
        
    - name: ä¸Šä¼ Releaseèµ„äº§ - ZIPåŒ…
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./ExcelDataProcessor-${{ steps.get_version.outputs.version }}-Windows.zip
        asset_name: ExcelDataProcessor-${{ steps.get_version.outputs.version }}-Windows.zip
        asset_content_type: application/zip
        
    - name: ä¸Šä¼ Releaseèµ„äº§ - EXEæ–‡ä»¶
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/ExcelDataProcessor.exe
        asset_name: ExcelDataProcessor-${{ steps.get_version.outputs.version }}.exe
        asset_content_type: application/octet-stream
        
    - name: æ„å»ºå®Œæˆé€šçŸ¥
      run: |
        Write-Host "ğŸ‰ æ„å»ºå’Œå‘å¸ƒå®Œæˆï¼"
        Write-Host "ğŸ“¦ Releaseç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        Write-Host "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: ${{ steps.create_release.outputs.html_url }}"